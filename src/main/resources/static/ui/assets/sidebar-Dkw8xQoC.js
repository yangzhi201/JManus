import{Q as v,r as S,_ as y,C as b,R as w}from"./index-cOT02xKk.js";import{L as T}from"./llm-check-CJy4TeZw.js";const x=v("task",()=>{const o=S(null),e=S(""),t=S(!1);return{currentTask:o,taskToInput:e,hasVisitedHome:t,setTask:r=>{if(console.log("[TaskStore] setTask called with prompt:",r),!r.trim()){console.warn("[TaskStore] Empty prompt provided, not creating task");return}const f={prompt:r,timestamp:Date.now(),processed:!1};o.value=f,console.log("[TaskStore] Task set, currentTask.value:",o.value)},setTaskToInput:r=>{console.log("[TaskStore] setTaskToInput called with prompt:",r),e.value=r,console.log("[TaskStore] Task to input set:",e.value)},getAndClearTaskToInput:()=>{const r=e.value;return e.value="",console.log("[TaskStore] getAndClearTaskToInput returning:",r),r},markTaskAsProcessed:()=>{console.log("[TaskStore] markTaskAsProcessed called, current task:",o.value),o.value?(o.value.processed=!0,console.log("[TaskStore] Task marked as processed:",o.value)):console.log("[TaskStore] No current task to mark as processed")},clearTask:()=>{o.value=null},hasUnprocessedTask:()=>{const r=o.value&&!o.value.processed;return console.log("[TaskStore] hasUnprocessedTask check - currentTask:",o.value,"result:",r),r},markHomeVisited:()=>{t.value=!0,localStorage.setItem("hasVisitedHome","true")},checkHomeVisited:()=>{const r=localStorage.getItem("hasVisitedHome");return t.value=r==="true",t.value},resetHomeVisited:()=>{t.value=!1,localStorage.removeItem("hasVisitedHome")},emitPlanExecutionRequested:r=>{console.log("[TaskStore] emitPlanExecutionRequested called with payload:",r),window.dispatchEvent(new CustomEvent("plan-execution-requested",{detail:r}))},setTaskRunning:r=>{console.log("[TaskStore] setTaskRunning called with planId:",r),o.value?(o.value.planId=r,o.value.isRunning=!0,console.log("[TaskStore] Updated existing task:",o.value)):(o.value={prompt:"",timestamp:Date.now(),processed:!1,planId:r,isRunning:!0},console.log("[TaskStore] Created new task for running state:",o.value))},stopCurrentTask:async()=>{if(console.log("[TaskStore] stopCurrentTask called"),o.value&&o.value.isRunning&&o.value.planId)try{const{DirectApiService:r}=await y(async()=>{const{DirectApiService:f}=await Promise.resolve().then(()=>A);return{DirectApiService:f}},void 0);return await r.stopTask(o.value.planId),console.log("[TaskStore] Task stopped successfully"),o.value.isRunning=!1,!0}catch(r){return console.error("[TaskStore] Failed to stop task:",r),!1}return!1},hasRunningTask:()=>{const r=o.value&&o.value.isRunning;return console.log("[TaskStore] hasRunningTask check - result:",r),r}}});class k{static BASE_URL="/api/executor";static async sendMessage(e){return T.withLlmCheck(async()=>{const t={...e,isVueRequest:!0},s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}static async sendMessageWithDefaultPlan(e){const t="default-plan-id-001000222",s={userRequirement:e.input};return this.executeByToolName(t,s,e.uploadedFiles,e.uploadKey)}static async executeByToolName(e,t,s,a){return T.withLlmCheck(async()=>{console.log("[DirectApiService] executeByToolName called with:",{toolName:e,replacementParams:t,uploadedFiles:s,uploadKey:a});const i={toolName:e,isVueRequest:!0};t&&Object.keys(t).length>0&&(i.replacementParams=t,console.log("[DirectApiService] Including replacement params:",t)),s&&s.length>0&&(i.uploadedFiles=s,console.log("[DirectApiService] Including uploaded files:",s.length)),a&&(i.uploadKey=a,console.log("[DirectApiService] Including uploadKey:",a)),console.log("[DirectApiService] Making request to:",`${this.BASE_URL}/executeByToolNameAsync`),console.log("[DirectApiService] Request body:",i);const c=await fetch(`${this.BASE_URL}/executeByToolNameAsync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.log("[DirectApiService] Response status:",c.status,c.ok),!c.ok){const l=await c.text();throw console.error("[DirectApiService] Request failed:",l),new Error(`Failed to execute: ${c.status}`)}const n=await c.json();return console.log("[DirectApiService] executeByToolName response:",n),n})}static async stopTask(e){return T.withLlmCheck(async()=>{console.log("[DirectApiService] Stopping task for planId:",e);const t=await fetch(`${this.BASE_URL}/stopTask/${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){const s=await t.json().catch(()=>({}));throw new Error(s.error||`Failed to stop task: ${t.status}`)}return await t.json()})}}const A=Object.freeze(Object.defineProperty({__proto__:null,DirectApiService:k},Symbol.toStringTag,{value:"Module"}));class h{static PLAN_TEMPLATE_URL="/api/plan-template";static CRON_TASK_URL="/api/cron-tasks";static async executePlan(e,t,s,a,i){return T.withLlmCheck(async()=>(console.log("[PlanActApiService] executePlan called with:",{planTemplateId:e,rawParam:t,uploadedFiles:s,replacementParams:a,uploadKey:i}),t&&(a||(a={}),a.userRequirement=t,console.log("[PlanActApiService] Added rawParam to replacementParams:",t)),await k.executeByToolName(e,a,s,i)))}static async savePlanTemplate(e,t){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e,planJson:t})});if(!s.ok)throw new Error(`Failed to save plan: ${s.status}`);return await s.json()}static async getPlanVersions(e){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!t.ok)throw new Error(`Failed to get plan versions: ${t.status}`);return await t.json()}static async getVersionPlan(e,t){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e,versionIndex:t.toString()})});if(!s.ok)throw new Error(`Failed to get specific version plan: ${s.status}`);return await s.json()}static async getAllPlanTemplates(){const e=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!e.ok)throw new Error(`Failed to get plan template list: ${e.status}`);return await e.json()}static async deletePlanTemplate(e){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!t.ok)throw new Error(`Failed to delete plan template: ${t.status}`);return await t.json()}static async createCronTask(e){const t=await fetch(this.CRON_TASK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)try{const s=await t.json();throw new Error(s.message||`Failed to create cron task: ${t.status}`)}catch{throw new Error(`Failed to create cron task: ${t.status}`)}return await t.json()}}const R=Object.freeze(Object.defineProperty({__proto__:null,PlanActApiService:h},Symbol.toStringTag,{value:"Module"}));class P{static async handleResponse(e){if(!e.ok)try{const t=await e.json();throw new Error(t.message||`API request failed: ${e.status}`)}catch{throw new Error(`API request failed: ${e.status} ${e.statusText}`)}return e}static async getAvailableTools(){try{const e=await fetch("/api/tools");return await(await this.handleResponse(e)).json()}catch(e){throw console.error("Failed to get available tools:",e),e}}}class C{isCollapsed=!1;currentTab="list";currentPlanTemplateId=null;planTemplateList=[];selectedTemplate=null;isLoading=!1;errorMessage="";jsonContent="";planType="dynamic_agent";generatorPrompt="";executionParams="";isGenerating=!1;isExecuting=!1;planVersions=[];currentVersionIndex=-1;availableTools=[];isLoadingTools=!1;toolsLoadError="";hasTaskRequirementModified=!1;organizationMethod="by_time";templateServiceGroups=new Map;groupCollapseState=new Map;constructor(){this.planVersions=[],this.currentVersionIndex=-1;const e=localStorage.getItem("sidebarOrganizationMethod");e&&["by_time","by_abc","by_group_time","by_group_abc"].includes(e)&&(this.organizationMethod=e),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const e=localStorage.getItem("sidebarGroupCollapseState");if(e){const t=JSON.parse(e);this.groupCollapseState=new Map(Object.entries(t).map(([s,a])=>[s==="null"?null:s,a]))}}catch(e){console.warn("[SidebarStore] Failed to load group collapse state:",e)}}saveGroupCollapseState(){try{const e={};this.groupCollapseState.forEach((t,s)=>{const a=s??"null";e[a]=t}),localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(e))}catch(e){console.warn("[SidebarStore] Failed to save group collapse state:",e)}}toggleGroupCollapse(e){const t=this.groupCollapseState.get(e)??!1;this.groupCollapseState.set(e,!t),this.saveGroupCollapseState()}isGroupCollapsed(e){return this.groupCollapseState.get(e)??!1}parseDateTime(e){return e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date}get sortedTemplates(){const e=[...this.planTemplateList];switch(this.organizationMethod){case"by_time":return e.sort((t,s)=>{const a=this.parseDateTime(t.updateTime??t.createTime);return this.parseDateTime(s.updateTime??s.createTime).getTime()-a.getTime()});case"by_abc":return e.sort((t,s)=>{const a=(t.title??"").toLowerCase(),i=(s.title??"").toLowerCase();return a.localeCompare(i)});case"by_group_time":case"by_group_abc":{const t=new Map,s=[];e.forEach(n=>{const l=this.templateServiceGroups.get(n.id)??"";!l||l==="default"||l===""?s.push(n):(t.has(l)||t.set(l,[]),t.get(l).push(n))});const a=new Map;t.forEach((n,l)=>{const p=[...n];this.organizationMethod==="by_group_time"?p.sort((u,d)=>{const m=this.parseDateTime(u.updateTime??u.createTime);return this.parseDateTime(d.updateTime??d.createTime).getTime()-m.getTime()}):p.sort((u,d)=>{const m=(u.title??"").toLowerCase(),g=(d.title??"").toLowerCase();return m.localeCompare(g)}),a.set(l,p)}),this.organizationMethod==="by_group_time"?s.sort((n,l)=>{const p=this.parseDateTime(n.updateTime??n.createTime);return this.parseDateTime(l.updateTime??l.createTime).getTime()-p.getTime()}):s.sort((n,l)=>{const p=(n.title??"").toLowerCase(),u=(l.title??"").toLowerCase();return p.localeCompare(u)});const i=[];return i.push(...s),Array.from(a.keys()).sort().forEach(n=>{i.push(...a.get(n))}),i}default:return e.sort((t,s)=>{const a=this.parseDateTime(t.updateTime??t.createTime);return this.parseDateTime(s.updateTime??s.createTime).getTime()-a.getTime()})}}get groupedTemplates(){if(this.organizationMethod!=="by_group_time"&&this.organizationMethod!=="by_group_abc")return new Map([[null,this.sortedTemplates]]);const e=new Map,t=[];this.sortedTemplates.forEach(c=>{const n=this.templateServiceGroups.get(c.id)??"";!n||n==="default"||n===""?t.push(c):(e.has(n)||e.set(n,[]),e.get(n).push(c))});const a=new Map;return t.length>0&&a.set(null,t),Array.from(e.keys()).sort().forEach(c=>{a.set(c,e.get(c))}),a}setOrganizationMethod(e){this.organizationMethod=e,localStorage.setItem("sidebarOrganizationMethod",e)}get canRollback(){return this.planVersions.length>1&&this.currentVersionIndex>0}get canRestore(){return this.planVersions.length>1&&this.currentVersionIndex<this.planVersions.length-1}get computedApiUrl(){if(!this.selectedTemplate)return"";const e=`/api/plan-template/execute/${this.selectedTemplate.id}`,t=this.executionParams.trim();return t?`${e}?allParams=${encodeURIComponent(t)}`:e}toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(e){this.currentTab=e}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[SidebarStore] Starting to load plan template list...");const e=await h.getAllPlanTemplates();e?.templates&&Array.isArray(e.templates)?(this.planTemplateList=e.templates,console.log(`[SidebarStore] Successfully loaded ${e.templates.length} plan templates`),await this.loadTemplateServiceGroups()):(this.planTemplateList=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",e))}catch(e){console.error("[SidebarStore] Failed to load plan template list:",e),this.planTemplateList=[];const t=e instanceof Error?e.message:"Unknown error";this.errorMessage=`Load failed: ${t}`}finally{this.isLoading=!1}}async loadTemplateServiceGroups(){this.templateServiceGroups.clear();const{CoordinatorToolApiService:e}=await y(async()=>{const{CoordinatorToolApiService:t}=await import("./coordinator-tool-api-service-Cu7Jic2v.js");return{CoordinatorToolApiService:t}},[]);for(const t of this.planTemplateList)try{const s=await e.getCoordinatorToolByTemplate(t.id);s?.serviceGroup&&this.templateServiceGroups.set(t.id,s.serviceGroup)}catch(s){console.debug(`No service group found for template ${t.id}:`,s)}}async selectTemplate(e){this.currentPlanTemplateId=e.id,this.selectedTemplate=e,this.currentTab="config",this.jsonContent="",await this.loadTemplateData(e),console.log(`[SidebarStore] Selected plan template: ${e.id}`)}async loadTemplateData(e){try{const t=await h.getPlanVersions(e.id);if(this.planVersions=t.versions||[],this.planVersions.length>0){const s=this.planVersions[this.planVersions.length-1];this.jsonContent=s,this.currentVersionIndex=this.planVersions.length-1,this.hasTaskRequirementModified=!1;try{const a=JSON.parse(s);a.prompt&&(this.generatorPrompt=a.prompt),a.params&&(this.executionParams=a.params),a.planType&&(this.planType=a.planType,console.log(`[SidebarStore] Updated planType to: ${this.planType}`))}catch{console.warn("Unable to parse JSON content to get prompt information")}}else this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planType="dynamic_agent",this.hasTaskRequirementModified=!1}catch(t){throw console.error("Failed to load template data:",t),t}}async createNewTemplate(e){const t={id:`new-${Date.now()}`,title:w.global.t("sidebar.newTemplateName"),description:w.global.t("sidebar.newTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.selectedTemplate=t,this.currentPlanTemplateId=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="config",this.planType=e,this.hasTaskRequirementModified=!1,console.log("[SidebarStore] ðŸ”„ Reloading available tools for new template"),await this.loadAvailableTools(),console.log("[SidebarStore] Created new empty plan template, switching to config tab")}async deleteTemplate(e){if(!e.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await h.deletePlanTemplate(e.id),this.currentPlanTemplateId===e.id&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[SidebarStore] Plan template ${e.id} has been deleted`)}catch(t){throw console.error("Failed to delete plan template:",t),await this.loadPlanTemplateList(),t}}clearSelection(){this.currentPlanTemplateId=null,this.selectedTemplate=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="list",this.hasTaskRequirementModified=!1}clearExecutionParams(){this.executionParams=""}rollbackVersion(){this.canRollback&&this.currentVersionIndex>0&&(this.currentVersionIndex--,this.jsonContent=this.planVersions[this.currentVersionIndex]||"")}restoreVersion(){this.canRestore&&this.currentVersionIndex<this.planVersions.length-1&&(this.currentVersionIndex++,this.jsonContent=this.planVersions[this.currentVersionIndex]||"")}async saveTemplate(){if(!this.selectedTemplate)return;const e=this.jsonContent.trim();if(!e)throw new Error("Content cannot be empty");try{JSON.parse(e)}catch(t){const s=t instanceof Error?t.message:"Unknown error";throw new Error(`Invalid format, please correct and save.
Error: `+s)}try{const t=await h.savePlanTemplate(this.selectedTemplate.id,e);return t?.planId&&this.selectedTemplate.id.startsWith("new-")&&(console.log("[SidebarStore] Updating template ID from",this.selectedTemplate.id,"to",t.planId),this.selectedTemplate.id=t.planId,this.currentPlanTemplateId=t.planId),this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(e),this.currentVersionIndex=this.planVersions.length-1,this.hasTaskRequirementModified=!1,t}catch(t){throw console.error("Failed to save plan template:",t),t}}preparePlanExecution(){if(!this.selectedTemplate)return null;this.isExecuting=!0;try{let e;try{e=JSON.parse(this.jsonContent),e.planTemplateId=this.selectedTemplate.id}catch{throw new Error("Failed to parse plan data")}return{title:this.selectedTemplate.title??e.title??"Execution Plan",planData:e,params:this.executionParams.trim()||void 0,replacementParams:void 0}}catch(e){throw console.error("Failed to prepare plan execution:",e),this.isExecuting=!1,e}}finishPlanExecution(){this.isExecuting=!1}async loadAvailableTools(){if(!this.isLoadingTools){this.isLoadingTools=!0,this.toolsLoadError="";try{console.log("[SidebarStore] Loading available tools...");const e=await P.getAvailableTools();console.log("[SidebarStore] Loaded available tools:",e),this.availableTools=e.map(t=>({key:t.key||"",name:t.name||"",description:t.description||"",enabled:t.enabled||!1,serviceGroup:t.serviceGroup||"default",selectable:t.selectable}))}catch(e){console.error("[SidebarStore] Error loading tools:",e),this.toolsLoadError=e instanceof Error?e.message:"Unknown error",this.availableTools=[]}finally{this.isLoadingTools=!1}}}}const D=b(new C);export{k as D,h as P,P as T,A as d,R as p,D as s,x as u};
//# sourceMappingURL=sidebar-Dkw8xQoC.js.map
